import Head from 'next/head'
import React, { useEffect, useState } from 'react'
import { authenticatedRequest } from '../client/http'
import { getTokenFromStorage } from '../client/localStorage'
import { apiRouteFile, apiRouteFileUpload } from '../client/routes'
import File from '../components/File/File'
import Header from '../components/Header/Header'
import AddFilesDialog from '../components/Partials/AddFilesDialog'
import { getUserFiles, getUserFilesIfNotExists } from '../store/filesStore'
import { getMe } from '../store/meStore'
import { useAppDispatch, useAppSelector } from '../store/store'

type HomeState = {
  selectedFiles: string[]
  isAddingFiles: boolean
}

export default function Home() {
  const dispatch = useAppDispatch()
  const { files, me } = useAppSelector((state) => ({
    files: state.files,
    me: state.me,
  }))
  const [state, setState] = useState<HomeState>({
    selectedFiles: [],
    isAddingFiles: false,
  })

  const request = authenticatedRequest(getTokenFromStorage())

  useEffect(() => {
    dispatch(getUserFilesIfNotExists)
    dispatch(getMe)
  }, [])

  const onCloseAddingFiles = () => setState({ ...state, isAddingFiles: false })
  const onOpenAddingFiles = () => setState({ ...state, isAddingFiles: true })

  const onSelectFile = (id: string) => {
    const isSelected = state.selectedFiles.includes(id)
    if (isSelected) {
      setState({
        ...state,
        selectedFiles: state.selectedFiles.filter(
          (selectedFile) => selectedFile !== id
        ),
      })
    } else {
      setState({ ...state, selectedFiles: state.selectedFiles.concat(id) })
    }
  }

  const onDeleteSelected = async () => {
    try {
      await request.delete(
        `${apiRouteFile}?${state.selectedFiles.reduce(
          (acc, next) => acc + '&id=' + next,
          ''
        )}`
      )
      setState({ ...state, selectedFiles: [] })
      dispatch(getUserFiles)
    } catch (error) {
      console.log(error)
    }
  }

  const onUpload = async (files: File[]) => {
    try {
      const formData = new FormData()
      files.forEach((file) => formData.append(file.name, file))
      await request.post(apiRouteFileUpload, formData)
      setState({ ...state, isAddingFiles: false })
      dispatch(getUserFiles)
    } catch (error) {
      console.log(error)
    }
  }

  return (
    <>
      <Head>
        <title>MyDrive</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div>
        <Header>
          <>
            <button className="header__upload" onClick={onOpenAddingFiles}>
              Upload files
            </button>
            <div className="header__avatar avatar">
              {me.name.substring(0, 1)}
            </div>
          </>
        </Header>
        <main className="main">
          <div className={'container'}>
            <h1 className="m-b-2">Files</h1>
            <div className="file-actions row">
              <p className="file-actions__action">search</p>
              <p className="file-actions__action">view: grid</p>
              <p className="file-actions__action">view: table</p>
              <p className="file-actions__action">sort</p>
              <p className="file-actions__action">filter</p>

              {Boolean(state.selectedFiles.length) && (
                <div className="file-actions__selected">
                  <button
                    className="file-actions__action"
                    onClick={onDeleteSelected}
                  >
                    Delete selected
                  </button>
                  <button className="file-actions__action">
                    Share selected
                  </button>
                </div>
              )}
            </div>
            <div className="row">
              {files.data.map((file) => (
                <File
                  key={file.id}
                  file={file}
                  onClick={() => onSelectFile(file.id)}
                  isSelected={Boolean(
                    state.selectedFiles.find((id) => id === file.id)
                  )}
                />
              ))}
            </div>
          </div>
        </main>
        <AddFilesDialog
          isOpen={state.isAddingFiles}
          onClose={onCloseAddingFiles}
          onUpload={onUpload}
        />
      </div>
    </>
  )
}
