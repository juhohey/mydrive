import Head from 'next/head'
import React, { SyntheticEvent, useEffect, useState } from 'react'
import { post } from '../client/http'
import { apiRouteFileUpload } from '../client/routes'
import Dialog from '../components/Dialog/Dialog'
import Header from '../components/Header/Header'
import { getUserFiles } from '../store/filesStore'
import store, { useAppDispatch, useAppSelector } from '../store/store'

export default function Home() {
  const dispatch = useAppDispatch()
  const files = useAppSelector((state) => state.files)
  const [state, setState] = useState({ isAddingFiles: false })
  useEffect(() => {
    dispatch(getUserFiles)
  }, [])

  const onCloseAddingFiles = () => setState({ ...state, isAddingFiles: false })
  const onOpenAddingFiles = () => setState({ ...state, isAddingFiles: true })
  return (
    <>
      <Head>
        <title>MyDrive</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <div>
        <Header>
          <>
            <button onClick={onOpenAddingFiles}>Upload</button>
            <div className="header__avatar avatar">
              <p>userName</p>
            </div>
          </>
        </Header>
        <main className="main">
          <div className={'container'}>
            <h1>Files</h1>
            <div>
              {files.data.map((file) => (
                <p key={file.id}>{file.name}</p>
              ))}
            </div>
          </div>
        </main>
        <AddFilesDialog
          isOpen={state.isAddingFiles}
          onClose={onCloseAddingFiles}
        />
      </div>
    </>
  )
}

type AddFilesDialogProps = {
  isOpen: boolean
  onClose: () => void
}

const AddFilesDialog = ({ isOpen, onClose }: AddFilesDialogProps) => {
  const [files, setFiles] = useState<File[]>([])

  const onSetFiles = (e: SyntheticEvent<HTMLInputElement>) => {
    const target = e.target as HTMLInputElement
    const files = target.files || []
    setFiles([...files])
  }

  const onUpload = async () => {
    try {
      const formData = new FormData()
      files.forEach((file) => formData.append(file.name, file))
      await post(apiRouteFileUpload, formData)
      onClose()
    } catch (error) {
      console.log('err', error)
    }
  }

  return (
    <Dialog
      isOpen={isOpen}
      onClose={onClose}
      onConfirm={onUpload}
      confirmLabel={'upload'}
    >
      <div className="m-b-4">
        <h1 className="m-b-1">Add files</h1>
        <input type="file" multiple={true} onChange={onSetFiles} />
      </div>
      <h2 className="m-b-1">Files</h2>
      <div className="upload-files">
        {files.map((file, i) => {
          return (
            <div key={i + file.name} className="upload-files__file">
              {file.name}
            </div>
          )
        })}
      </div>
    </Dialog>
  )
}
